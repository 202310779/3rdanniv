<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>3rd Anniversary</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html,
    body {
      width: 100%;
      height: 100%;
      overflow: hidden;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at 20% 10%, #ffffff 0, #d9f3ff 35%, #9ac7ff 60%, #5a7ac2 100%);
    }

    body {
      display: flex;
      align-items: stretch;
      justify-content: center;
    }

    /* Scene root */
    .scene {
      position: relative;
      width: 100vw;
      height: 100vh;
      overflow: hidden;
      background: linear-gradient(to top, rgba(63, 122, 56, 0.65) 0%, rgba(90, 173, 103, 0.0) 50%, rgba(0, 0, 0, 0) 100%);
    }

    /* Soft vignette for cinematic feel */
    .scene::after {
      content: "";
      position: absolute;
      inset: 0;
      pointer-events: none;
      background: radial-gradient(circle at 50% 20%, transparent 0%, transparent 45%, rgba(0, 0, 0, 0.25) 100%);
      mix-blend-mode: multiply;
    }

    /* Sun glow */
    .sun-glow {
      position: absolute;
      width: 40vw;
      max-width: 480px;
      aspect-ratio: 1 / 1;
      border-radius: 50%;
      top: -15vh;
      right: -10vw;
      background: radial-gradient(circle, rgba(255, 255, 255, 0.95), rgba(255, 248, 210, 0.6), rgba(255, 234, 167, 0.0));
      filter: blur(2px);
      opacity: 0.9;
      pointer-events: none;
    }

    /* Field layers container */
    .field {
      position: absolute;
      inset: 0;
      display: block;
      pointer-events: none;
    }

    .layer {
      position: absolute;
      left: 0;
      width: 100%;
      bottom: 0;
      transform-origin: bottom;
      will-change: transform;
    }

    .layer--back {
      height: 55vh;
      z-index: 1;
      filter: blur(1.2px) saturate(0.9);
    }

    .layer--mid {
      height: 65vh;
      z-index: 2;
      filter: blur(0.4px) saturate(1.0);
    }

    .layer--front {
      height: 75vh;
      z-index: 3;
      filter: saturate(1.1);
    }

    /* Ground strip */
    .ground {
      position: absolute;
      left: -5vw;
      width: 110vw;
      bottom: -4vh;
      height: 16vh;
      background:
        radial-gradient(circle at 20% 0%, rgba(255, 255, 255, 0.35), transparent 55%),
        radial-gradient(circle at 80% 0%, rgba(255, 255, 255, 0.25), transparent 55%),
        linear-gradient(to top, #28411f 0%, #2f5a22 35%, #3f7b2b 70%, rgba(63, 123, 53, 0) 100%);
      box-shadow: 0 -20px 40px rgba(0, 0, 0, 0.4) inset;
      z-index: 4;
    }

    /* Pollen / dust layer */
    .pollen-layer {
      position: absolute;
      inset: 0;
      pointer-events: none;
      overflow: hidden;
      z-index: 5;
      mix-blend-mode: screen;
    }

    .pollen {
      position: absolute;
      width: 3px;
      height: 3px;
      border-radius: 50%;
      background: radial-gradient(circle, rgba(255, 255, 255, 0.9), rgba(255, 255, 255, 0));
      opacity: 0.0;
      filter: blur(0.2px);
      animation-name: floatParticle;
      animation-timing-function: linear;
      animation-iteration-count: infinite;
    }

    @keyframes floatParticle {
      0% {
        transform: translate3d(0, 0, 0) scale(0.8);
        opacity: 0;
      }
      10% {
        opacity: 0.7;
      }
      70% {
        opacity: 0.4;
      }
      100% {
        transform: translate3d(var(--dx), -20vh, 0) scale(1.05);
        opacity: 0;
      }
    }

    /* Grass blades */
    .grass-blade {
      position: absolute;
      bottom: 0;
      width: 2px;
      border-radius: 999px;
      transform-origin: 50% 100%;
      background: linear-gradient(to top, rgba(12, 40, 10, 0.95) 0%, rgba(35, 104, 41, 0.95) 40%, rgba(160, 220, 150, 0.95) 100%);
      box-shadow: 0 0 3px rgba(0, 0, 0, 0.45);
      will-change: transform, background-color;
      pointer-events: none;
    }

    .grass-blade::before {
      /* subtle highlight along one edge */
      content: "";
      position: absolute;
      left: 0;
      top: 0;
      bottom: 15%;
      width: 1px;
      border-radius: inherit;
      background: linear-gradient(to top, rgba(255, 255, 255, 0.0), rgba(255, 255, 255, 0.35));
      opacity: 0.9;
      mix-blend-mode: screen;
    }

    /* Flower base position (placed at upper segment of blade) */
    .flower {
      position: absolute;
      left: 50%;
      transform-origin: 50% 100%;
      transform: translateX(-50%);
      will-change: transform;
    }

    /* Simple round flower core; petals come from shadows and pseudo-elements */
    .flower-core {
      position: relative;
      border-radius: 50%;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.35);
    }

    .flower-core::before,
    .flower-core::after {
      content: "";
      position: absolute;
      inset: -40%;
      border-radius: 50%;
      background: radial-gradient(circle, rgba(255, 255, 255, 0.95), rgba(255, 255, 255, 0));
      opacity: 0.9;
      mix-blend-mode: screen;
    }

    .flower-core::after {
      inset: -25%;
      opacity: 0.8;
    }

    /* Daisy-style petals using box-shadow */
    .flower--daisy .flower-core {
      background: radial-gradient(circle, #ffe684 0, #f6b700 55%, #c48900 100%);
      box-shadow:
        0 0 0 2px rgba(255, 255, 255, 0.9),
        0 0 0 6px rgba(255, 255, 255, 0.88),
        0 0 0 9px rgba(255, 255, 255, 0.86);
    }

    /* Tiny wildflowers */
    .flower--tiny .flower-core {
      background: radial-gradient(circle, #ffffff 0, #f3f3ff 55%, #c0c2ff 100%);
      box-shadow:
        0 0 0 3px rgba(244, 244, 255, 0.9),
        0 0 6px rgba(255, 255, 255, 0.9);
    }

    /* Colorful wildflowers */
    .flower--wild .flower-core {
      background: radial-gradient(circle, var(--flower-core), var(--flower-core-dark));
      box-shadow:
        0 0 0 3px rgba(255, 255, 255, 0.9),
        0 0 7px var(--flower-glow);
    }

    /* Slight petal distortion via scaling */
    .flower--daisy .flower-core,
    .flower--tiny .flower-core,
    .flower--wild .flower-core {
      transform-origin: center;
      transform: scaleX(1.15) scaleY(1);
    }

    /* Foreground soft focus splashes */
    .foreground-haze {
      position: absolute;
      left: -10vw;
      right: -10vw;
      bottom: -10vh;
      height: 55vh;
      background:
        radial-gradient(circle at 20% 10%, rgba(255, 255, 255, 0.09), transparent 55%),
        radial-gradient(circle at 80% 20%, rgba(255, 255, 255, 0.07), transparent 50%);
      filter: blur(9px);
      opacity: 0.8;
      pointer-events: none;
      z-index: 6;
      mix-blend-mode: screen;
    }

    /* Center photo frame */
    .center-photo {
      position: absolute;
      left: 50%;
      top: 44vh;
      transform: translate(-50%, -50%);
      max-width: min(38vw, 340px);
      aspect-ratio: 4 / 5;
      border-radius: 18px;
      overflow: hidden;
      box-shadow:
        0 20px 45px rgba(0, 0, 0, 0.55),
        0 0 0 1px rgba(255, 255, 255, 0.65);
      background:
        linear-gradient(145deg, rgba(255, 255, 255, 0.4), rgba(255, 255, 255, 0.05));
      backdrop-filter: blur(6px);
      z-index: 6;
      animation: floatPhoto 12s ease-in-out infinite;
      pointer-events: none; /* keep interactions on scene & buttons */
    }

    .center-photo img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
      filter: saturate(1.04) contrast(1.03);
    }

    @keyframes floatPhoto {
      0% {
        transform: translate(-50%, -50%) translateY(0);
      }
      50% {
        transform: translate(-50%, -50%) translateY(8px);
      }
      100% {
        transform: translate(-50%, -50%) translateY(0);
      }
    }

    /* Open letter button */
    .letter-button {
      position: absolute;
      right: 3vw;
      bottom: 5vh;
      z-index: 7;
      padding: 0.7rem 1.4rem;
      border-radius: 999px;
      border: none;
      background: radial-gradient(circle at 30% 0%, #fff7df, #ffd1a1);
      color: #5a3520;
      font-size: 0.95rem;
      font-weight: 600;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.35);
      cursor: pointer;
      backdrop-filter: blur(4px);
      transition: transform 0.25s ease, box-shadow 0.25s ease, background 0.25s ease, opacity 0.3s ease;
      opacity: 0.96;
    }

    .letter-button:hover {
      transform: translateY(-2px) scale(1.02);
      box-shadow: 0 16px 30px rgba(0, 0, 0, 0.4);
      background: radial-gradient(circle at 30% 0%, #fff9ea, #ffbf7d);
    }

    .letter-button:active {
      transform: translateY(0) scale(0.98);
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.35);
    }

    /* Letter modal overlay */
    .letter-modal {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: radial-gradient(circle at 20% 0%, rgba(255, 255, 255, 0.16), transparent 55%),
                  radial-gradient(circle at 80% 100%, rgba(0, 0, 0, 0.7), rgba(0, 0, 0, 0.9));
      backdrop-filter: blur(10px);
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.35s ease, visibility 0.35s ease;
      z-index: 20;
    }

    .letter-modal.is-visible {
      opacity: 1;
      visibility: visible;
    }

    .letter-modal__panel {
      position: relative;
      max-width: min(540px, 90vw);
      max-height: min(70vh, 90vh);
      padding: 1.6rem 1.9rem 1.7rem;
      border-radius: 18px;
      background:
        radial-gradient(circle at 0% 0%, rgba(255, 255, 255, 0.56), transparent 65%),
        linear-gradient(145deg, rgba(255, 255, 255, 0.98), rgba(255, 245, 228, 0.96));
      box-shadow:
        0 18px 45px rgba(0, 0, 0, 0.7),
        0 0 0 1px rgba(255, 255, 255, 0.7);
      color: #3e2c26;
      overflow: hidden;
    }

    .letter-modal__title {
      font-size: 1.15rem;
      font-weight: 700;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      margin-bottom: 0.9rem;
      color: #9b5a39;
    }

    .letter-modal__body {
      max-height: 42vh;
      padding-right: 0.4rem;
      font-size: 0.98rem;
      line-height: 1.7;
      overflow-y: auto;
      scrollbar-width: thin;
    }

    .letter-modal__body::-webkit-scrollbar {
      width: 6px;
    }

    .letter-modal__body::-webkit-scrollbar-track {
      background: transparent;
    }

    .letter-modal__body::-webkit-scrollbar-thumb {
      background: rgba(0, 0, 0, 0.15);
      border-radius: 999px;
    }

    .letter-modal__footer {
      margin-top: 1.1rem;
      display: flex;
      justify-content: flex-end;
      gap: 0.6rem;
      font-size: 0.85rem;
    }

    .letter-modal__close {
      padding: 0.45rem 0.95rem;
      border-radius: 999px;
      border: none;
      background: linear-gradient(120deg, #f2d0b2, #e9a97f);
      color: #55301f;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 8px 18px rgba(0, 0, 0, 0.25);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .letter-modal__close:hover {
      transform: translateY(-1px);
      box-shadow: 0 12px 22px rgba(0, 0, 0, 0.3);
    }

    .letter-modal__close:active {
      transform: translateY(0);
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.25);
    }

    /* Responsive tweaks */
    @media (max-width: 768px) {
      .layer--back {
        height: 50vh;
      }
      .layer--mid {
        height: 60vh;
      }
      .layer--front {
        height: 70vh;
      }
      .ground {
        height: 18vh;
      }
      .center-photo {
        top: 40vh;
        max-width: min(70vw, 260px);
        border-radius: 16px;
      }
      .letter-button {
        right: 5vw;
        bottom: 4vh;
        font-size: 0.85rem;
        padding: 0.55rem 1.2rem;
      }
      .letter-modal__panel {
        max-width: min(92vw, 520px);
        padding: 1.25rem 1.45rem 1.4rem;
      }
      .letter-modal__title {
        font-size: 1.02rem;
      }
      .letter-modal__body {
        font-size: 0.95rem;
      }
    }
  </style>
</head>
<body>
  <!-- Background music: rename your file to music.mp3 (no spaces or &), or update the src below to exactly match the file name in your repo -->
  <audio id="bg-music" src="ephemeral.mp3" preload="auto" loop></audio>

  <div class="scene" id="scene">
    <div class="sun-glow"></div>
    <div class="field" id="field">
      <div class="layer layer--back" data-depth="0.3"></div>
      <div class="layer layer--mid" data-depth="0.6"></div>
      <div class="layer layer--front" data-depth="1.0"></div>
    </div>
    <!-- Centered photo: replace photo.jpg with your image file name -->
    <div class="center-photo" id="center-photo">
      <img src="unangpic.jpg" alt="Our photo" />
    </div>
    <div class="ground"></div>
    <div class="pollen-layer" id="pollen-layer"></div>
    <div class="foreground-haze"></div>
    <button class="letter-button" id="open-letter-btn">Open Letter</button>
  </div>

  <div class="letter-modal" id="letter-modal">
    <div class="letter-modal__panel">
      <div class="letter-modal__title">Happy Anniversary BEBEEEE!</div>
      <div class="letter-modal__body" id="letter-body">
        <p>Hi Bubba,</p>
        <p>
          I still can’t believe it’s been three years. We’ve been through so much there are good days, hard days, and challenges I never thought we’d face. But thank you for staying, for standing right beside me, for supporting me and loving me through everything.
        </p>
        <p>
      You’re my safe place, my comfort, and the person I always choose. Even on ordinary days, you make everything feel lighter.
        </p>
        <p>
         I’m sorry I can’t buy you flowers this anniversary, so I made something instead. I coded these lily of the valleys for you—small, simple, but made with so much love.
        </p>
        <p> Happy 3rd anniversary. I love you!!!!!!</p>
      </div>
      <div class="letter-modal__footer">
        <button class="letter-modal__close" id="close-letter-btn">Close</button>
      </div>
    </div>
  </div>

  <script>
    // Meadow configuration
    const CONFIG = {
      grassDensityPer1000px: 120, // how many blades per 1000px width per layer (scaled by depth)
      maxBladesPerLayer: 420,
      minBladeHeight: 40,
      maxBladeHeight: 165,
      baseLeanMaxDeg: 10,
      idleWindAmplitudeDeg: 5,
      gustAmplitudeDeg: 7,
      mouseInfluenceRadius: 260,
      mouseMaxPushDeg: 26,
      stiffness: 0.035,
      damping: 0.86,
      idleBreezeSpeed: 0.00055,
      gustPeriodMs: 15000,
      flowersPer100Blades: 25,
      pollenCount: 48
    };

    const blades = []; // stores dynamic data for animation
    let animationId = null;
    let lastTime = performance.now();
    let sceneBounds = null;

    // Background music state
    let musicStarted = false;

    let mouse = {
      x: 0,
      y: 0,
      isActive: false,
      lastMoveTime: performance.now()
    };

    function randomBetween(min, max) {
      return Math.random() * (max - min) + min;
    }

    function lerp(a, b, t) {
      return a + (b - a) * t;
    }

    function clamp(v, min, max) {
      return v < min ? min : v > max ? max : v;
    }

    function createPollenParticles() {
      const pollenLayer = document.getElementById("pollen-layer");
      pollenLayer.innerHTML = "";
      const count = CONFIG.pollenCount;
      for (let i = 0; i < count; i++) {
        const p = document.createElement("div");
        p.className = "pollen";
        const startX = Math.random() * 100;
        const startY = randomBetween(40, 100);
        const dx = randomBetween(-25, 25) + "vw";
        const duration = randomBetween(18, 36); // seconds
        const delay = randomBetween(-duration, 0);
        p.style.left = startX + "vw";
        p.style.bottom = startY + "vh";
        p.style.setProperty("--dx", dx);
        p.style.animationDuration = duration + "s";
        p.style.animationDelay = delay + "s";
        pollenLayer.appendChild(p);
      }
    }

    function createMeadow() {
      const field = document.getElementById("field");
      const layers = Array.from(field.querySelectorAll(".layer"));
      // Clear existing blades and animation state
      layers.forEach(layer => (layer.innerHTML = ""));
      blades.length = 0;

      const width = window.innerWidth;
      const baseBladeCount = (width / 1000) * CONFIG.grassDensityPer1000px;

      // Precompute color variations for grass greens
      const baseHue = 115;
      const hueRange = 16;

      layers.forEach(layer => {
        const depth = parseFloat(layer.dataset.depth || "1");
        const layerFactor = lerp(0.6, 1.2, depth);
        let count = Math.round(baseBladeCount * layerFactor);
        count = Math.min(count, CONFIG.maxBladesPerLayer);

        for (let i = 0; i < count; i++) {
          const blade = document.createElement("div");
          blade.className = "grass-blade";

          // Horizontal placement: random but denser towards center for natural clusters
          const t = Math.random();
          const bias = 0.3;
          const centered = (t - 0.5) * (1 - bias) + 0.5;
          const xPercent = centered * 100;
          const xPx = (xPercent / 100) * width;

          const baseHeight = randomBetween(CONFIG.minBladeHeight, CONFIG.maxBladeHeight) * lerp(0.7, 1.05, depth);
          const heightScale = lerp(0.85, 1.15, Math.random());
          const visualHeight = baseHeight * heightScale;

          blade.style.left = xPercent + "vw";
          blade.style.height = visualHeight + "px";

          // Slight vertical variation: deeper blades start a bit higher
          const bottomOffset = randomBetween(0, 14) * depth;
          blade.style.bottom = bottomOffset + "px";

          // Color variation
          const hue = baseHue + randomBetween(-hueRange, hueRange);
          const sat = randomBetween(55, 80);
          const light = randomBetween(26, 46);
          const gradient = `linear-gradient(to top, hsl(${hue}, ${sat}%, ${light - 12}%) 0%, hsl(${hue}, ${sat + 5}%, ${light + 8}%) 40%, hsl(${hue + 4}, ${sat + 10}%, ${light + 20}%) 100%)`;
          blade.style.backgroundImage = gradient;

          layer.appendChild(blade);

          // Determine if this blade gets a flower (front & mid layers more likely)
          let hasFlower = false;
          let flowerEl = null;
          const flowerChanceBase = CONFIG.flowersPer100Blades / 100;
          const depthBoost = lerp(0.1, 0.5, depth);
          const flowerChance = flowerChanceBase * (0.6 + depthBoost);

          if (Math.random() < flowerChance) {
            hasFlower = true;
            const flower = document.createElement("div");
            flower.classList.add("flower");

            // Choose height along blade for flower (higher in front, mid otherwise)
            const relativeHeight = lerp(0.55, 0.9, Math.random() * (0.6 + depth * 0.6));
            flower.style.bottom = (relativeHeight * visualHeight) + "px";

            const flowerCore = document.createElement("div");
            flowerCore.classList.add("flower-core");

            // Choose flower type
            const r = Math.random();
            let typeClass;
            if (r < 0.35) {
              typeClass = "flower--tiny";
            } else if (r < 0.7) {
              typeClass = "flower--daisy";
            } else {
              typeClass = "flower--wild";
            }
            flower.classList.add(typeClass.replace(".", ""));

            // Size & color variations
            const sizeBase = lerp(6, 11, Math.random());
            const depthScale = lerp(0.7, 1.0, depth);
            const size = sizeBase * depthScale;

            flowerCore.style.width = size + "px";
            flowerCore.style.height = size + "px";

            // Color for wildflowers
            if (typeClass === "flower--wild") {
              const palette = [
                { core: "#ff9aa2", dark: "#f04f59", glow: "rgba(255, 154, 162, 0.8)" },
                { core: "#ffdac1", dark: "#ffb780", glow: "rgba(255, 218, 193, 0.8)" },
                { core: "#b5ead7", dark: "#5bbfa1", glow: "rgba(181, 234, 215, 0.8)" },
                { core: "#c7ceff", dark: "#8593ff", glow: "rgba(199, 206, 255, 0.85)" },
                { core: "#ffd6e0", dark: "#ff9ac1", glow: "rgba(255, 150, 196, 0.85)" }
              ];
              const chosen = palette[Math.floor(Math.random() * palette.length)];
              flowerCore.style.setProperty("--flower-core", chosen.core);
              flowerCore.style.setProperty("--flower-core-dark", chosen.dark);
              flowerCore.style.setProperty("--flower-glow", chosen.glow);
            }

            flower.appendChild(flowerCore);

            // Slight rotation and sway offset per flower
            const flowerTilt = randomBetween(-14, 14);
            flower.style.transform += ` rotate(${flowerTilt}deg)`;

            blade.appendChild(flower);
            flowerEl = flower;
          }

          const baseLean = randomBetween(-CONFIG.baseLeanMaxDeg, CONFIG.baseLeanMaxDeg) * lerp(0.6, 1.2, depth);

          blades.push({
            el: blade,
            flowerEl,
            xPx,
            depth,
            baseLean,
            currentAngle: baseLean,
            targetAngle: baseLean,
            velocity: 0,
            idlePhase: Math.random() * Math.PI * 2,
            idleOffset: randomBetween(-1, 1),
            stiffness: CONFIG.stiffness * lerp(0.75, 1.3, Math.random()),
            damping: CONFIG.damping + randomBetween(-0.05, 0.05),
            flowerAngle: baseLean,
          });
        }
      });

      sceneBounds = document.getElementById("scene").getBoundingClientRect();
    }

    function handleMouseMove(evt) {
      mouse.isActive = true;
      mouse.lastMoveTime = performance.now();
      mouse.x = evt.clientX;
      mouse.y = evt.clientY;
    }

    function handleMouseLeave() {
      mouse.isActive = false;
    }

    function animate(time) {
      const dt = time - lastTime;
      lastTime = time;
      const dtNorm = clamp(dt / 16.67, 0.4, 1.6); // normalize timestep for smoother motion

      if (!sceneBounds) {
        sceneBounds = document.getElementById("scene").getBoundingClientRect();
      }

      const idleFactor = clamp((time - mouse.lastMoveTime) / 1800, 0, 1); // more idle as time passes

      // Compute gust factor: slow envelope over time
      const gustProgress = (time % CONFIG.gustPeriodMs) / CONFIG.gustPeriodMs; // 0..1
      const gust = Math.sin(gustProgress * Math.PI * 2) * Math.sin(gustProgress * Math.PI);
      const gustStrength = gust * CONFIG.gustAmplitudeDeg;

      for (let i = 0; i < blades.length; i++) {
        const b = blades[i];
        const depth = b.depth;

        // Idle breeze: sin wave with per-blade phase, weaker in back
        const idleAmp = CONFIG.idleWindAmplitudeDeg * lerp(0.35, 1.0, depth);
        const idle = Math.sin(time * CONFIG.idleBreezeSpeed + b.idlePhase + b.idleOffset) * idleAmp * idleFactor;

        // Gust contributes even when mouse is moving, but subtle
        const gustContribution = gustStrength * lerp(0.45, 1.0, depth);

        // Mouse interaction
        let mousePush = 0;
        if (mouse.isActive) {
          const baseY = sceneBounds.bottom;
          const dx = b.xPx - mouse.x;
          const dy = baseY - mouse.y;
          const dist = Math.sqrt(dx * dx + dy * dy);
          const influence = clamp(1 - dist / CONFIG.mouseInfluenceRadius, 0, 1);
          if (influence > 0) {
            const dir = dx > 0 ? 1 : -1; // bend away from cursor horizontally
            const push = dir * CONFIG.mouseMaxPushDeg * influence * influence;
            mousePush = push;
          }
        }

        const target = b.baseLean + idle + gustContribution * 0.55 + mousePush;
        b.targetAngle = target;

        const stiffness = b.stiffness;
        const damping = b.damping;

        const accel = (b.targetAngle - b.currentAngle) * stiffness;
        b.velocity += accel * dtNorm;
        b.velocity *= damping;
        b.currentAngle += b.velocity;

        const scaleY = lerp(0.92, 1.0, depth);
        const translateY = lerp(6, -4, depth);
        b.el.style.transform = `translate3d(0, ${translateY}px, 0) rotate(${b.currentAngle}deg) scaleY(${scaleY})`;

        if (b.flowerEl) {
          // Flowers slightly exaggerate and smoothly follow the blade motion
          const targetFlowerAngle = b.currentAngle * lerp(1.05, 1.18, 1 - depth);
          const followSpeed = lerp(0.06, 0.12, 1 - depth); // foreground flowers react a bit faster
          b.flowerAngle = lerp(b.flowerAngle, targetFlowerAngle, clamp(followSpeed * dtNorm, 0, 1));
          b.flowerEl.style.transform = `translateX(-50%) rotate(${b.flowerAngle}deg)`;
        }
      }

      animationId = requestAnimationFrame(animate);
    }

    function startAnimation() {
      if (animationId != null) cancelAnimationFrame(animationId);
      lastTime = performance.now();
      animationId = requestAnimationFrame(animate);
    }

    function onResize() {
      // Debounced regeneration for responsiveness
      if (animationId != null) {
        cancelAnimationFrame(animationId);
        animationId = null;
      }
      createMeadow();
      startAnimation();
    }

    function tryStartMusic() {
      const audio = document.getElementById("bg-music");
      if (!audio || musicStarted) return;
      const playPromise = audio.play();
      if (playPromise && typeof playPromise.then === "function") {
        playPromise
          .then(() => {
            musicStarted = true;
          })
          .catch(() => {
            // Autoplay blocked; will retry on user interaction
          });
      } else {
        musicStarted = true;
      }
    }

    function initScene() {
      createPollenParticles();
      createMeadow();
      startAnimation();

      // Attempt immediate autoplay; many browsers may require user interaction
      tryStartMusic();

      const scene = document.getElementById("scene");
      scene.addEventListener("mousemove", handleMouseMove);
      scene.addEventListener("mouseleave", handleMouseLeave);

      // Open letter popup wiring
      const openLetterBtn = document.getElementById("open-letter-btn");
      const letterModal = document.getElementById("letter-modal");
      const closeLetterBtn = document.getElementById("close-letter-btn");

      if (openLetterBtn && letterModal && closeLetterBtn) {
        openLetterBtn.addEventListener("click", () => {
          letterModal.classList.add("is-visible");
        });

        closeLetterBtn.addEventListener("click", () => {
          letterModal.classList.remove("is-visible");
        });

        letterModal.addEventListener("click", (evt) => {
          if (evt.target === letterModal) {
            letterModal.classList.remove("is-visible");
          }
        });
      }

      let resizeTimeout;
      window.addEventListener("resize", () => {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(onResize, 220);
      });

      // Fallback: start music on first interaction if autoplay was blocked
      const interactionHandler = () => {
        if (!musicStarted) {
          tryStartMusic();
        }
        if (musicStarted) {
          document.removeEventListener("click", interactionHandler);
          document.removeEventListener("keydown", interactionHandler);
        }
      };
      document.addEventListener("click", interactionHandler);
      document.addEventListener("keydown", interactionHandler);
    }

    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", initScene);
    } else {
      initScene();
    }
  </script>
</body>
</html>
